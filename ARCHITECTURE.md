# Ralph Loop - ç¨‹å¼ç¢¼æž¶æ§‹ç¸½çµ

## æ ¸å¿ƒè¨­è¨ˆåŽŸå‰‡ï¼ˆåŸºæ–¼ ralph-claude-codeï¼‰

### 1. è¿´åœˆæŽ§åˆ¶çš„ä¸‰å€‹å±¤æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ‡‰ç”¨ç¨‹å¼å±¤ (app)              â”‚
â”‚   - æ•´åˆæ‰€æœ‰æ¨¡çµ„                 â”‚
â”‚   - å¯¦ä½œæ¥­å‹™é‚è¼¯                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è¿´åœˆæŽ§åˆ¶å±¤ (ghcopilot)         â”‚
â”‚   â”œâ”€ CLI åŸ·è¡Œå™¨                 â”‚
â”‚   â”œâ”€ è¼¸å‡ºè§£æžå™¨                 â”‚
â”‚   â”œâ”€ å›žæ‡‰åˆ†æžå™¨ (ralph æ–¹å¼)    â”‚
â”‚   â”œâ”€ ç†”æ–·å™¨                     â”‚
â”‚   â””â”€ é€€å‡ºåµæ¸¬                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CLI å±¤ (github-copilot-cli)   â”‚
â”‚   - åŸ·è¡Œ what-the-shell         â”‚
â”‚   - åŸ·è¡Œå…¶ä»–æŒ‡ä»¤                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. é›™é‡æ¢ä»¶é€€å‡ºé©—è­‰ ðŸ”‘

```go
func (ra *ResponseAnalyzer) IsCompleted() bool {
    // æ¢ä»¶ 1: æœ‰è¶³å¤ çš„å®ŒæˆæŒ‡æ¨™ï¼ˆåˆ†æ•¸ >= 20ï¼‰
    if len(ra.completionIndicators) < 2 {
        return false
    }
    
    // æ¢ä»¶ 2: AI æ˜Žç¢ºç™¼å‡º EXIT_SIGNAL = true
    status := ra.ParseStructuredOutput()
    if status == nil || !status.ExitSignal {
        return false
    }
    
    // é›™é‡æ¢ä»¶éƒ½æ»¿è¶³æ‰é€€å‡º
    return true
}
```

**ç‚ºä»€éº¼éœ€è¦é›™é‡æ¢ä»¶?**

| å ´æ™¯ | å®ŒæˆæŒ‡æ¨™ | EXIT_SIGNAL | çµæžœ | é¢¨éšª |
|------|----------|------------|------|------|
| AI é‚„åœ¨æ€è€ƒ | < 2 | false | ç¹¼çºŒ âœ… | ç„¡ |
| AI è¿·èŒ« | 3+ | false | ç¹¼çºŒ âœ… | ç„¡ |
| èª¤åˆ¤å®Œæˆ | 3+ | false | ç¹¼çºŒ âœ… | ç„¡ |
| **éŽæ—©é€€å‡º** | 3+ | false | ~~é€€å‡º~~ âœ… | è¢«é˜²æ­¢ |
| **ç„¡é™è¿´åœˆ** | < 2 | true | ~~é€€å‡º~~ âœ… | è¢«é˜²æ­¢ |
| æ­£ç¢ºå®Œæˆ | 3+ | true | é€€å‡º âœ… | ç„¡ |

### 3. å®Œæˆä¿¡è™Ÿçš„å±¤æ¬¡

```
å±¤æ¬¡ 1: çµæ§‹åŒ–ä¿¡è™Ÿï¼ˆæœ€å¯é ï¼‰
â”œâ”€ EXIT_SIGNAL = true (100 åˆ†)
â””â”€ ä¾†è‡ª ---COPILOT_STATUS--- å€å¡Š

å±¤æ¬¡ 2: è‡ªç„¶èªžè¨€é—œéµå­—ï¼ˆæ¬¡å¯é ï¼‰
â”œâ”€ å®Œæˆ / å®Œå…¨å®Œæˆ (10 åˆ†)
â”œâ”€ æ²’æœ‰æ›´å¤šå·¥ä½œ (15 åˆ†)
â””â”€ æº–å‚™å°±ç·’ (10 åˆ†)

å±¤æ¬¡ 3: ä¸Šä¸‹æ–‡ç·šç´¢ï¼ˆè¼”åŠ©ï¼‰
â””â”€ è¼¸å‡ºçŸ­å° (10 åˆ†) â†’ è¡¨ç¤ºé€²åº¦ç”šå¾®

æ±ºç­–: å¿…é ˆå±¤æ¬¡ 1 + (å±¤æ¬¡ 2 æˆ–å±¤æ¬¡ 3)
```

## æ¨¡çµ„äº’å‹•æµç¨‹

### å…¸åž‹çš„è¿´åœˆåŸ·è¡Œæµç¨‹

```
1. å–å¾—ä½¿ç”¨è€…è«‹æ±‚
   â†“
2. CLIExecutor.SuggestShellCommand()
   â”œâ”€ åŸ·è¡Œ github-copilot-cli
   â””â”€ å›žå‚³ ExecutionResult
   â†“
3. OutputParser
   â”œâ”€ æå–ç¨‹å¼ç¢¼å€å¡Š
   â”œâ”€ æå–é¸é …åˆ—è¡¨
   â””â”€ æ¸…é™¤ Markdown æ ¼å¼
   â†“
4. ResponseAnalyzer
   â”œâ”€ è§£æžçµæ§‹åŒ–è¼¸å‡º
   â”œâ”€ è¨ˆç®—å®Œæˆåˆ†æ•¸
   â”œâ”€ åµæ¸¬æ¸¬è©¦è¿´åœˆ
   â”œâ”€ åµæ¸¬å¡ä½ç‹€æ…‹
   â””â”€ æª¢æŸ¥é›™é‡æ¢ä»¶ â† é—œéµæ±ºç­–é»ž
   â†“
5. CircuitBreaker
   â”œâ”€ è¨˜éŒ„é€²åº¦æˆ–éŒ¯èª¤
   â”œâ”€ æª¢æŸ¥ç†”æ–·ç‹€æ…‹
   â””â”€ æ±ºå®šæ˜¯å¦ç¹¼çºŒ
   â†“
6. åˆ¤æ–·:
   â”œâ”€ IsCompleted() = true â†’ ðŸ˜Š é€€å‡ºè¿´åœˆ
   â”œâ”€ CircuitBreaker.IsOpen() = true â†’ âš ï¸ é–‹å•Ÿç†”æ–·
   â””â”€ å…¶ä»– â†’ â†» é€²å…¥ä¸‹ä¸€è¿´åœˆ
```

## æ•…éšœæ¢å¾©ç­–ç•¥

### ç†”æ–·å™¨ç‹€æ…‹è½‰æ›

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CLOSED    â”‚
                    â”‚ (æ­£å¸¸é‹ä½œ)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    å¤±æ•—Ã—3 â”‚ (ç„¡é€²å±•/ç›¸åŒéŒ¯èª¤)
                           â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    OPEN     â”‚
                    â”‚ (åœæ­¢åŸ·è¡Œ)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    æˆåŠŸ Ã— 1â”‚
                           â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        å¤±æ•— â†â”€â”€â”€â”€â”€â”¤ HALF_OPEN   â”‚
                    â”‚ (è©¦æŽ¢æ¢å¾©)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                    æˆåŠŸ Ã— 1â”‚
                           â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CLOSED    â”‚
                    â”‚ (æ¢å¾©æ­£å¸¸)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•¸æ“šæµç¯„ä¾‹

### æ­£å¸¸å®Œæˆæµç¨‹

```json
// ç¬¬ 1 è¼ª
{
  "response": "---COPILOT_STATUS---\nSTATUS: CONTINUE\nEXIT_SIGNAL: false\n---END_STATUS---\n\nå®Œæˆäº†ç¬¬ä¸€æ­¥",
  "completion_score": 10,
  "completion_indicators": ["short_output"],
  "is_completed": false,
  "circuit_breaker_state": "CLOSED"
}

// ç¬¬ 2 è¼ª
{
  "response": "æ‰€æœ‰ä»»å‹™å·²å®Œæˆã€‚---COPILOT_STATUS---\nSTATUS: DONE\nEXIT_SIGNAL: true\n---END_STATUS---",
  "completion_score": 125,
  "completion_indicators": ["explicit_exit_signal", "å®Œæˆ"],
  "is_completed": true,  // é›™é‡æ¢ä»¶æ»¿è¶³ âœ…
  "circuit_breaker_state": "CLOSED"
}

çµæžœ: EXIT âœ…
```

### æ•…éšœæ¢å¾©æµç¨‹

```json
// ç¬¬ 1 è¼ª: éŒ¯èª¤
{
  "error": "Connection timeout",
  "circuit_breaker": {
    "state": "CLOSED",
    "same_error_loops": 1
  }
}

// ç¬¬ 2-4 è¼ª: é‡è¤‡éŒ¯èª¤
{
  "error": "Connection timeout",
  "circuit_breaker": {
    "state": "CLOSED",
    "same_error_loops": 5  // é”åˆ°é–¾å€¼
  }
}

// ç¬¬ 5 è¼ª
{
  "circuit_breaker": {
    "state": "OPEN"  // ðŸ”´ ç†”æ–·å™¨æ‰“é–‹
  }
}

çµæžœ: STOP (ç­‰å¾…æ‰‹å‹•ä»‹å…¥)
```

## æ€§èƒ½å„ªåŒ–

### 1. å®Œæˆæª¢æ¸¬çš„é€Ÿåº¦

```
æ–¹æ¡ˆ A: æ¯è¿´åœˆéƒ½åš NLP è™•ç†
â”œâ”€ æˆæœ¬: é«˜
â”œâ”€ æº–ç¢ºçŽ‡: 75%
â””â”€ é¢¨éšª: å®¹æ˜“éŽæ—©é€€å‡º

æ–¹æ¡ˆ B (æŽ¡ç”¨): çµæ§‹åŒ– + NLP æ··åˆ
â”œâ”€ çµæ§‹åŒ– (100ms, 99% æº–ç¢º)
â”œâ”€ NLP åƒ…ä½œè¼”åŠ© (10ms, 80% æº–ç¢º)
â”œâ”€ æˆæœ¬: ä½Ž
â””â”€ æº–ç¢ºçŽ‡: 95%+
```

### 2. è¨˜æ†¶é«”ä½¿ç”¨

```
ç†”æ–·å™¨ç‹€æ…‹æŒä¹…åŒ–:
â”œâ”€ æœ€å¾Œ 3 å€‹éŒ¯èª¤: ~300 å­—ç¯€
â”œâ”€ ç‹€æ…‹è³‡è¨Š: ~200 å­—ç¯€
â”œâ”€ ç¸½è¨ˆ: ~500 å­—ç¯€
â””â”€ é å°æ–¼å…§å­˜é™åˆ¶
```

## æ“´å±•é»ž

### 1. æ–°å¢žå®ŒæˆæŒ‡æ¨™

åœ¨ `response_analyzer.go` çš„ `CalculateCompletionScore()`:

```go
// æ–°å¢žæŒ‡æ¨™
newKeywords := []string{"æ–°æŒ‡æ¨™1", "æ–°æŒ‡æ¨™2"}
for _, keyword := range newKeywords {
    if strings.Contains(response, keyword) {
        score += 20
        completionIndicators = append(...)
        break
    }
}
```

### 2. æ–°å¢žç†”æ–·æ¢ä»¶

åœ¨ `circuit_breaker.go` æ–°å¢žæ–¹æ³•:

```go
func (cb *CircuitBreaker) RecordCustomCondition(condition bool) {
    if condition {
        cb.openCircuit("è‡ªè¨‚æ¢ä»¶è§¸ç™¼")
    }
}
```

### 3. æ–°å¢žç‹€æ…‹ä¿¡è™Ÿ

åœ¨ `response_analyzer.go` çš„ `CopilotStatus` çµæ§‹:

```go
type CopilotStatus struct {
    Status        string
    ExitSignal    bool
    TasksDone     string
    NewField      string  // æ–°å¢žæ¬„ä½
}
```

---

**è¨­è¨ˆæ–‡ä»¶ç‰ˆæœ¬**: 1.0  
**ä¸Šæ¬¡æ›´æ–°**: 2026-01-20  
**ç›¸é—œæ–‡ä»¶**: [IMPLEMENTATION_PROGRESS.md](./IMPLEMENTATION_PROGRESS.md)
