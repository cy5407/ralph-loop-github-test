# Stage 8.3 Batch 2 規劃摘要

**日期**: 2026-01-22  
**狀態**: 📋 規劃完成，準備開始實現  
**下一步**: 開始 Batch 2 實現（階段 1：重試策略）

---

## 📈 進度快照

### Batch 1 成果（已完成 ✅）
- **新增測試**: 42 個
- **新增代碼**: ~1,200 行
- **總測試數**: 172 個（通過率 100%）
- **完成度**: 100%

### Batch 2 規劃（已完成 📋）
- **目標測試數**: 20-25 個
- **預期代碼**: 800-1000 行
- **預期總測試**: 192-197 個
- **預期完成時間**: 2.5-3.5 小時

---

## 🎯 Batch 2 核心目標

Batch 2 聚焦於**容錯和恢復機制**，分為 5 個實現階段：

### 階段 1：重試策略（6-8 個測試）
實現多種重試策略，應對不同的故障場景：
- **ExponentialBackoffRetry**: 指數退避（推薦用於臨時故障）
- **LinearBackoffRetry**: 線性退避（推薦用於資源限制）
- **FixedIntervalRetry**: 固定間隔（用於已知恢復時間）

**文件**: `retry_strategy.go`  
**預期代碼**: 200-250 行  
**測試覆蓋**: 6-8 個  

### 階段 2：故障檢測（5-6 個測試）
實現多層故障檢測機制，精準識別系統故障：
- **TimeoutDetector**: 執行超時檢測
- **ErrorRateDetector**: 錯誤率監控（滑動窗口）
- **HealthCheckDetector**: 系統健康檢查
- **MultiDetector**: 多檢測器組合

**文件**: `failure_detection.go`  
**預期代碼**: 250-300 行  
**測試覆蓋**: 5-6 個  

### 階段 3：恢復機制（4-5 個測試）
實現自動恢復策略，智能應對故障：
- **AutoReconnectRecovery**: 自動重連
- **SessionRestoreRecovery**: 會話恢復
- **FallbackRecovery**: 故障轉移（SDK → CLI）
- **RecoveryCoordinator**: 恢復協調

**文件**: `recovery_mechanism.go`  
**預期代碼**: 250-300 行  
**測試覆蓋**: 4-5 個  

### 階段 4：執行器集成（4-6 個測試）
整合所有容錯機制到執行器中：
- **FaultTolerantExecutor**: 主容錯執行器
- 集成重試、檢測、恢復三大機制
- 提供統一的執行介面
- 完整的性能指標

**文件**: `fault_tolerant_executor.go`  
**預期代碼**: 300-350 行  
**測試覆蓋**: 4-6 個  

### 階段 5：Client 擴展（1-2 個測試）
將容錯執行器集成到 RalphLoopClient：
- 新增 SDK 容錯執行方法
- 支援動態配置
- 提供監控介面

**文件**: 修改 `client.go`  
**預期代碼**: 50-100 行  
**測試覆蓋**: 1-2 個  

---

## 📋 重要概念速查

### 重試延遲計算

| 策略 | 計算公式 | 用途 |
|------|---------|------|
| 指數退避 | `min(delay × 2^attempt, maxDelay)` | 臨時故障 |
| 線性退避 | `min(delay + increment×attempt, maxDelay)` | 資源恢復 |
| 固定間隔 | 固定值 | 已知場景 |

### 故障檢測模式

```
TimeoutDetector: executionTime > threshold
ErrorRateDetector: (failures / window_size) > threshold
HealthCheckDetector: unhealthy_count > maxUnhealthy
MultiDetector: detector1.Detect() OR detector2.Detect() OR ...
```

### 恢復優先級

```
Priority 高: AutoReconnectRecovery (臨時連接問題)
Priority 中: SessionRestoreRecovery (會話問題)
Priority 低: FallbackRecovery (完全故障)
```

### 完整執行流

```
執行 → 檢測故障 → 決定重試 → 嘗試恢復 → 等待延遲 → 重新執行
              ↑                           ↓
              └───────────────────────────┘
              (達到最大重試次數則返回錯誤)
```

---

## 📊 性能預期

### 代碼量
| 項目 | 數量 |
|------|------|
| 新增文件 | 4-5 個 |
| 新增代碼行 | 800-1000 |
| 新增測試 | 20-25 個 |
| 文檔和評註 | ~200 行 |

### 測試量
| 項目 | 當前 | 完成後 | 增長 |
|------|------|--------|------|
| 總測試 | 172 | 192-197 | +20-25 |
| 通過率 | 100% | 100% | 保持 |
| 覆蓋率 | ~85% | >90% | +5% |

### 時間估計
| 階段 | 時間 |
|------|------|
| 1. 重試策略 | 30-40 分鐘 |
| 2. 故障檢測 | 30-40 分鐘 |
| 3. 恢復機制 | 30-40 分鐘 |
| 4. 執行器 | 30-40 分鐘 |
| 5. Client | 15-20 分鐘 |
| 測試調試 | 20-30 分鐘 |
| **總計** | **150-190 分鐘** |

---

## 🔑 關鍵決策

### 1. 重試策略選擇
**決策**: 支援三種策略，讓使用者根據場景選擇
- **原因**: 不同故障類型需要不同的重試方式
- **優點**: 靈活應對各種場景
- **風險**: 複雜度增加（已通過統一介面降低）

### 2. 多層故障檢測
**決策**: 使用多個獨立檢測器的組合模式
- **原因**: 單一檢測器易產生誤判
- **優點**: 提高檢測準確性
- **風險**: 檢測開銷略增（在可接受範圍）

### 3. 優先級恢復策略
**決策**: 根據優先級順序嘗試恢復
- **原因**: 某些恢復策略成本高，應優先嘗試低成本方案
- **優點**: 最小化恢復開銷
- **風險**: 需要精確的優先級設置

### 4. SDK→CLI 故障轉移
**決策**: 支援 SDK 失效時自動轉向 CLI
- **原因**: 提高系統整體可用性
- **優點**: 雙重保障
- **風險**: 語義轉換複雜度（已有 CLIExecutor 支援）

---

## 📚 規劃文檔位置

| 文檔 | 用途 | 位置 |
|------|------|------|
| **STAGE_8_3_BATCH_2_PLANNING.md** | 完整詳細規劃 | 當前目錄 |
| **BATCH_2_IMPLEMENTATION_FRAMEWORK.md** | 實現框架和詳解 | 當前目錄 |
| **BATCH_2_QUICK_REFERENCE.md** | 快速參考指南 | 當前目錄 |
| **本文檔** | 規劃摘要 | 當前目錄 |

### 推薦閱讀順序
1. 📄 **本文檔** (5 分鐘) - 概覽規劃
2. 📋 **STAGE_8_3_BATCH_2_PLANNING.md** (15 分鐘) - 詳細設計
3. 🔨 **BATCH_2_IMPLEMENTATION_FRAMEWORK.md** (20 分鐘) - 實現指南
4. ⚡ **BATCH_2_QUICK_REFERENCE.md** (10 分鐘) - 開發參考

---

## ✅ 規劃檢查清單

- [x] Batch 1 順利完成（172 個測試通過）
- [x] 5 個實現階段完整規劃
- [x] 20-25 個測試用例設計
- [x] 詳細的代碼框架和範例
- [x] 完整的文檔和指南
- [x] 時間和資源估計
- [x] 風險識別和緩解
- [x] 性能目標和指標

---

## 🚀 後續行動

### 立即行動（現在）
1. 確認規劃無誤
2. 準備開發環境
3. 閱讀詳細規劃文檔

### 短期行動（今天）
1. 開始階段 1：重試策略實現
2. 編寫單元測試
3. 代碼審查

### 中期行動（本週）
1. 完成階段 1-5
2. 全部測試通過
3. 生成最終報告

### 長期行動（下週）
1. Batch 3：執行模式選擇器
2. Stage 8.3 最終驗證
3. 生產環境部署準備

---

## 📞 支援和協作

### 如有問題，請：
1. 查看 [BATCH_2_QUICK_REFERENCE.md](BATCH_2_QUICK_REFERENCE.md) 的常見問題部分
2. 查看 [STAGE_8_3_BATCH_2_PLANNING.md](STAGE_8_3_BATCH_2_PLANNING.md) 的詳細設計
3. 查看相關的程式碼實現（sdk_executor.go, circuit_breaker.go）

### 代碼評論要點：
- 線程安全性（使用 sync.RWMutex）
- 錯誤處理完整性
- 文檔和註釋清晰度
- 測試覆蓋率 > 90%
- 性能無明顯迴歸

---

## 📊 Success Criteria

Batch 2 成功完成的標準：

✅ **代碼質量**
- [ ] 所有 20-25 個新測試通過
- [ ] 總測試數達到 192-197 個
- [ ] 代碼覆蓋率 > 90%
- [ ] 通過率 100%

✅ **功能完整**
- [ ] 三種重試策略完整實現
- [ ] 多層故障檢測正常運作
- [ ] 三種恢復機制可用
- [ ] 容錯執行器集成無誤
- [ ] Client 方法集成完成

✅ **性能目標**
- [ ] 無明顯性能迴歸
- [ ] 重試延遲計算正確
- [ ] 恢復機制高效
- [ ] 內存開銷 < 10 KB/執行

✅ **文檔完整**
- [ ] 代碼有清晰註釋
- [ ] 新增模組有說明文檔
- [ ] 測試用例有描述
- [ ] API 文檔更新

---

**準備好開始了嗎？**

👉 [開始 Batch 2 實現](STAGE_8_3_BATCH_2_PLANNING.md) 或 [查看快速參考](BATCH_2_QUICK_REFERENCE.md)

---

*此規劃由 GitHub Copilot 於 2026-01-22 生成*
